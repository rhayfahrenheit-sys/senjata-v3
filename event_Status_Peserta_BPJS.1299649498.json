{
	"type": "EVENT_BUTTON",
	"name": "Status Peserta BPJS",
	"serverCode": "// Proses NIK\r\n$nik = str_replace(array(\"-\", \" \"), \"\", $params[\"value\"]);\r\n\r\n//proses bridging pcare mencari data peserta by nik\r\n// Setup konfigurasi kredensial (sesuaikan dengan variabel Anda)\r\nloadSecrets();\r\n$keyenc=RM;\r\n$cons=msy_decrypt('cons',$keyenc);\r\n$password=msy_decrypt('password',$keyenc);\r\n$user_key=msy_decrypt('user_key',$keyenc);\r\n$secret=msy_decrypt('secret',$keyenc);\r\n\r\n\r\n\r\n$sp=DB::PrepareSQL(\"select user1,kode_provider,\".$cons.\",\".$password.\",\".$user_key.\",\".$secret.\" from puskesmas where pusk_id=:1\",$_SESSION[\"puskesmas\"]);\r\n$rs=DB::Query($sp);\r\nwhile( $data = $rs->fetchAssoc() )\r\n{\r\n$cons1 = $data[\"cons\"];\r\n$password1 = $data[\"password\"];\r\n$user_key1 = $data[\"user_key\"];\r\n$user1 = $data[\"user1\"];\r\n$secret1= $data[\"secret\"];\r\n}\r\n\r\n\tdate_default_timezone_set('UTC'); \r\n\t$stamp = strval(time()-strtotime('1970-01-01 00:00:00'));\r\n\t//$stamp\t\t= time();\r\n\t$data \t\t= $cons1.'&'.$stamp;\r\n\t$key\t\t= $cons1.$secret1.$stamp;\r\n\r\n$config = array(\r\n    'consID'     => $cons1,\r\n    'secretKey'  => $secret1,\r\n    'user_key'   => $user_key1,\r\n    'pcareUname' => $user1,\r\n    'pcarePWD'   => $password1,\r\n    'kdAplikasi' => '095' // default, bisa diubah jika perlu\r\n);\r\n\r\n// Base URL PCare\r\n$base_url = $_SESSION[\"base_url_pcare\"];\r\n\r\n// ============ CONTOH 1: Get Peserta by NOKA ============\r\n\r\n$result_pcare = pcare_get_peserta_nik($base_url, $nik, $config);\r\n\r\nif ($result_pcare['success']) {\r\n    $responseData = $result_pcare['data'][\"response\"];\r\n    $decryptedData = decrypt_pcare_data($responseData, $key);\r\n    //$decryptedData=json_decode($decryptedData, true);\r\n    \r\n    if ($decryptedData !== null) {\r\n        // echo \"Decrypt berhasil!<br>\";\r\n        // echo \"Data count: \" . count($decryptedData) . \"<br>\";\r\n        // echo \"<pre>\";\r\n        // print_r($decryptedData);\r\n        // echo \"</pre>\";\r\n        $result[\"noKartu\"] = $decryptedData[\"noKartu\"];\r\n        $result[\"nama\"] = $decryptedData[\"nama\"];\r\n        $result[\"sex\"] = $decryptedData[\"sex\"];\r\n        $result[\"tglLahir\"] = $decryptedData[\"tglLahir\"];\r\n        $result[\"tglMulaiAktif\"] = $decryptedData[\"tglMulaiAktif\"];\r\n        $result[\"tglAkhirBerlaku\"] = $decryptedData[\"tglAkhirBerlaku\"];\r\n        $result[\"nmProvider\"] = $decryptedData[\"kdProviderPst\"][\"nmProvider\"];\r\n        $result[\"jnsKelas\"] = $decryptedData[\"jnsKelas\"][\"nama\"];\r\n        $result[\"jnsPeserta\"] = $decryptedData[\"jnsPeserta\"][\"nama\"];\r\n        $result[\"golDarah\"] = $decryptedData[\"golDarah\"];\r\n        $result[\"noHP\"] = $decryptedData[\"noHP\"];\r\n        $result[\"noKTP\"] = $decryptedData[\"noKTP\"];\r\n        $result[\"ketAktif\"] = $decryptedData[\"ketAktif\"];\r\n        $result[\"tunggakan\"] = $decryptedData[\"tunggakan\"];\r\n        \r\n    } else {\r\n        $errorMsg = get_pcare_decrypt_error();\r\n        echo \"Error Decrypt: \" . $errorMsg;\r\n    }\r\n}",
	"beforeJsCode": "// Ambil nilai NIK dan bersihkan dari karakter non-numerik\r\nvar ctrlKtp = Runner.getControl(pageid, 'ktp');\r\n //params['ktp']= ctrlKtp.getValue();\r\n \r\n \r\nvar nikValue = ctrlKtp.getValue();\r\nif (nikValue && nikValue.length > 0) {\r\n    // Bersihkan NIK dari tanda strip dan spasi\r\n    nikValue = nikValue.replace(/[-\\s]/g, \"\");\r\n    params[\"value\"] = nikValue;\r\n    \r\n    // Validasi panjang NIK (harus 16 digit)\r\n    if (nikValue.length !== 16) {\r\n        alert(\"NIK harus terdiri dari 16 digit!\");\r\n        return false;\r\n    }\r\n    \r\n    // Validasi NIK hanya berisi angka\r\n    if (!/^\\d+$/.test(nikValue)) {\r\n        alert(\"NIK hanya boleh berisi angka!\");\r\n        return false;\r\n    }\r\n} else {\r\n    // Jika NIK kosong, kosongkan juga tgl_lahir\r\n    params[\"value\"] = \"\";\r\n}\r\n\r\n",
	"afterJsCode": "//set field dari bridging pcare\r\n// Tampilkan hasil bridging dengan SweetAlert yang informatif dan menarik\r\n// Format PHPRunner: $result[\"key\"] di server = result[\"key\"] di client\r\n\r\n// Tentukan status keaktifan dengan warna\r\nvar statusColor = result[\"ketAktif\"] === 'AKTIF' ? '#28a745' : '#dc3545';\r\nvar statusIcon = result[\"ketAktif\"] === 'AKTIF' ? '✅' : '⚠️';\r\n\r\n// Tentukan status tunggakan\r\nvar tunggakanStatus = result[\"tunggakan\"] === '0' || result[\"tunggakan\"] === 'TIDAK' ? 'Tidak Ada' : 'Ada Tunggakan';\r\nvar tunggakanColor = result[\"tunggakan\"] === '0' || result[\"tunggakan\"] === 'TIDAK' ? '#28a745' : '#ffc107';\r\n\r\n// Format HTML untuk tampilan yang rapi\r\nvar htmlContent = `\r\n<div style=\"font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-height: 400px; overflow-y: auto;\">\r\n    <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px 8px 0 0; text-align: center; margin: -20px -20px 20px -20px;\">\r\n        <h3 style=\"margin: 0; font-size: 20px;\">\r\n            <i class=\"fas fa-id-card\"></i> Data Peserta BPJS Kesehatan\r\n        </h3>\r\n        <p style=\"margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;\">\r\n            ${result[\"noKartu\"] || '-'}\r\n        </p>\r\n    </div>\r\n    \r\n    <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 15px;\">\r\n        <!-- Kolom 1 -->\r\n        <div>\r\n            <div style=\"margin-bottom: 12px;\">\r\n                <span style=\"color: #6c757d; font-size: 12px; display: block; margin-bottom: 4px;\">\r\n                    <i class=\"fas fa-user\"></i> Nama Lengkap\r\n                </span>\r\n                <strong style=\"font-size: 14px; color: #212529;\">${result[\"nama\"] || '-'}</strong>\r\n            </div>\r\n            \r\n            <div style=\"margin-bottom: 12px;\">\r\n                <span style=\"color: #6c757d; font-size: 12px; display: block; margin-bottom: 4px;\">\r\n                    <i class=\"fas fa-venus-mars\"></i> Jenis Kelamin\r\n                </span>\r\n                <span style=\"font-size: 14px;\">${result[\"sex\"] === 'L' ? 'Laki-Laki' : result[\"sex\"] === 'P' ? 'Perempuan' : '-'}</span>\r\n            </div>\r\n            \r\n            <div style=\"margin-bottom: 12px;\">\r\n                <span style=\"color: #6c757d; font-size: 12px; display: block; margin-bottom: 4px;\">\r\n                    <i class=\"fas fa-calendar-alt\"></i> Tanggal Lahir\r\n                </span>\r\n                <span style=\"font-size: 14px;\">${result[\"tglLahir\"] || '-'}</span>\r\n            </div>\r\n            \r\n            <div style=\"margin-bottom: 12px;\">\r\n                <span style=\"color: #6c757d; font-size: 12px; display: block; margin-bottom: 4px;\">\r\n                    <i class=\"fas fa-tint\"></i> Golongan Darah\r\n                </span>\r\n                <span style=\"font-size: 14px;\">${result[\"golDarah\"] || '-'}</span>\r\n            </div>\r\n            \r\n            <div style=\"margin-bottom: 12px;\">\r\n                <span style=\"color: #6c757d; font-size: 12px; display: block; margin-bottom: 4px;\">\r\n                    <i class=\"fas fa-id-card\"></i> No. KTP\r\n                </span>\r\n                <span style=\"font-size: 14px;\">${result[\"noKTP\"] || '-'}</span>\r\n            </div>\r\n        </div>\r\n        \r\n        <!-- Kolom 2 -->\r\n        <div>\r\n            <div style=\"margin-bottom: 12px;\">\r\n                <span style=\"color: #6c757d; font-size: 12px; display: block; margin-bottom: 4px;\">\r\n                    <i class=\"fas fa-hospital\"></i> Provider\r\n                </span>\r\n                <span style=\"font-size: 14px;\">${result[\"nmProvider\"] || '-'}</span>\r\n            </div>\r\n            \r\n            <div style=\"margin-bottom: 12px;\">\r\n                <span style=\"color: #6c757d; font-size: 12px; display: block; margin-bottom: 4px;\">\r\n                    <i class=\"fas fa-layer-group\"></i> Kelas\r\n                </span>\r\n                <span style=\"font-size: 14px;\">${result[\"jnsKelas\"] || '-'}</span>\r\n            </div>\r\n            \r\n            <div style=\"margin-bottom: 12px;\">\r\n                <span style=\"color: #6c757d; font-size: 12px; display: block; margin-bottom: 4px;\">\r\n                    <i class=\"fas fa-user-tag\"></i> Jenis Peserta\r\n                </span>\r\n                <span style=\"font-size: 14px;\">${result[\"jnsPeserta\"] || '-'}</span>\r\n            </div>\r\n            \r\n            <div style=\"margin-bottom: 12px;\">\r\n                <span style=\"color: #6c757d; font-size: 12px; display: block; margin-bottom: 4px;\">\r\n                    <i class=\"fas fa-phone\"></i> No. HP\r\n                </span>\r\n                <span style=\"font-size: 14px;\">${result[\"noHP\"] || '-'}</span>\r\n            </div>\r\n            \r\n            <div style=\"margin-bottom: 12px;\">\r\n                <span style=\"color: #6c757d; font-size: 12px; display: block; margin-bottom: 4px;\">\r\n                    <i class=\"fas fa-calendar-check\"></i> Periode Aktif\r\n                </span>\r\n                <span style=\"font-size: 14px;\">${result[\"tglMulaiAktif\"] || '-'} s/d ${result[\"tglAkhirBerlaku\"] || '-'}</span>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    \r\n    <!-- Status Bar -->\r\n    <div style=\"margin-top: 20px; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid ${statusColor};\">\r\n        <div style=\"display: flex; justify-content: space-between; align-items: center;\">\r\n            <div>\r\n                <span style=\"color: #6c757d; font-size: 12px; display: block; margin-bottom: 4px;\">\r\n                    Status Keanggotaan\r\n                </span>\r\n                <strong style=\"font-size: 16px; color: ${statusColor};\">\r\n                    ${statusIcon} ${result[\"ketAktif\"] || '-'}\r\n                </strong>\r\n            </div>\r\n            <div style=\"text-align: right;\">\r\n                <span style=\"color: #6c757d; font-size: 12px; display: block; margin-bottom: 4px;\">\r\n                    Status Tunggakan\r\n                </span>\r\n                <strong style=\"font-size: 16px; color: ${tunggakanColor};\">\r\n                    ${result[\"tunggakan\"] === '0' ? '✅' : '⚠️'} ${tunggakanStatus}\r\n                </strong>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    \r\n    <!-- Info Footer -->\r\n    <div style=\"margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 6px; border-left: 4px solid #2196F3;\">\r\n        <span style=\"color: #1976d2; font-size: 12px;\">\r\n            <i class=\"fas fa-info-circle\"></i> Data diambil dari Sistem PCare BPJS Kesehatan\r\n        </span>\r\n    </div>\r\n</div>\r\n`;\r\n\r\n// Tampilkan SweetAlert\r\nSwal.fire({\r\n    title: '<strong>✅ Data Peserta Berhasil Diambil</strong>',\r\n    html: htmlContent,\r\n    icon: 'success',\r\n    confirmButtonText: 'Tutup',\r\n    confirmButtonColor: '#667eea',\r\n    width: '600px',\r\n    customClass: {\r\n        popup: 'swal2-border-radius-10',\r\n        title: 'swal2-title-custom',\r\n        confirmButton: 'swal2-confirm-custom'\r\n    },\r\n    buttonsStyling: false,\r\n    didOpen: () => {\r\n        // Auto-focus pada tombol\r\n        const confirmButton = Swal.getConfirmButton();\r\n        confirmButton.focus();\r\n    }\r\n});\r\n\r\n// Custom CSS untuk styling tambahan\r\nvar style = document.createElement('style');\r\nstyle.innerHTML = `\r\n.swal2-border-radius-10 {\r\n    border-radius: 12px !important;\r\n    box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important;\r\n}\r\n.swal2-title-custom {\r\n    font-weight: 600 !important;\r\n    font-size: 18px !important;\r\n    color: #212529 !important;\r\n}\r\n.swal2-confirm-custom {\r\n    font-weight: 600 !important;\r\n    padding: 10px 25px !important;\r\n    font-size: 14px !important;\r\n    border-radius: 8px !important;\r\n    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4) !important;\r\n    transition: all 0.3s ease !important;\r\n}\r\n.swal2-confirm-custom:hover {\r\n    transform: translateY(-2px) !important;\r\n    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6) !important;\r\n}\r\n`;\r\ndocument.head.appendChild(style);\r\n\r\n//end\r\n"
}