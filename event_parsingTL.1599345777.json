{
	"type": "EVENT_FIELD",
	"name": "parsingTL",
	"serverCode": "// Proses NIK\r\n$nik = str_replace(array(\"-\", \" \"), \"\", $params[\"value\"]);\r\n\r\nif (empty($nik)) {\r\n    $result[\"birthdate\"] = \"\";\r\n    $result[\"success\"] = true;\r\n    $result[\"error\"] = \"\";\r\n} else {\r\n    $nikResult = msy_nikToBirthdate($nik);\r\n    $result[\"birthdate\"] = $nikResult['birthdate'];\r\n    $result[\"success\"] = $nikResult['success'];\r\n    $result[\"error\"] = $nikResult['error'];\r\n}\r\n\r\n\r\n//proses bridging pcare mencari data peserta by nik\r\n// Setup konfigurasi kredensial (sesuaikan dengan variabel Anda)\r\nloadSecrets();\r\n$keyenc=RM;\r\n$cons=msy_decrypt('cons',$keyenc);\r\n$password=msy_decrypt('password',$keyenc);\r\n$user_key=msy_decrypt('user_key',$keyenc);\r\n$secret=msy_decrypt('secret',$keyenc);\r\n\r\n\r\n\r\n$sp=DB::PrepareSQL(\"select user1,kode_provider,\".$cons.\",\".$password.\",\".$user_key.\",\".$secret.\" from puskesmas where pusk_id=:1\",$_SESSION[\"puskesmas\"]);\r\n// echo $sp;\r\n// exit();\r\n$rs=DB::Query($sp);\r\nwhile( $data = $rs->fetchAssoc() )\r\n{\r\n$cons1 = $data[\"cons\"];\r\n$password1 = $data[\"password\"];\r\n$user_key1 = $data[\"user_key\"];\r\n$user1 = $data[\"user1\"];\r\n$secret1= $data[\"secret\"];\r\n}\r\n\r\n\tdate_default_timezone_set('UTC'); \r\n\t$stamp = strval(time()-strtotime('1970-01-01 00:00:00'));\r\n\t//$stamp\t\t= time();\r\n\t$data \t\t= $cons1.'&'.$stamp;\r\n\t$key\t\t= $cons1.$secret1.$stamp;\r\n\r\n$config = array(\r\n    'consID'     => $cons1,\r\n    'secretKey'  => $secret1,\r\n    'user_key'   => $user_key1,\r\n    'pcareUname' => $user1,\r\n    'pcarePWD'   => $password1,\r\n    'kdAplikasi' => '095' // default, bisa diubah jika perlu\r\n);\r\n\r\n// Base URL PCare\r\n$base_url = $_SESSION[\"base_url_pcare\"];\r\n\r\n// ============ CONTOH 1: Get Peserta by NOKA ============\r\n\r\n$result_pcare = pcare_get_peserta_nik($base_url, $nik, $config);\r\n\r\nif ($result_pcare['success']) {\r\n    $responseData = $result_pcare['data'][\"response\"];\r\n    $decryptedData = decrypt_pcare_data($responseData, $key);\r\n    //$decryptedData=json_decode($decryptedData, true);\r\n    \r\n    if ($decryptedData !== null) {\r\n        // echo \"Decrypt berhasil!<br>\";\r\n        // echo \"Data count: \" . count($decryptedData) . \"<br>\";\r\n        // echo \"<pre>\";\r\n        // print_r($decryptedData);\r\n        // echo \"</pre>\";\r\n        $result[\"noKartu\"] = $decryptedData[\"noKartu\"];\r\n        $result[\"nama\"] = $decryptedData[\"nama\"];\r\n        $result[\"sex\"] = $decryptedData[\"sex\"];\r\n        $result[\"tglLahir\"] = $decryptedData[\"tglLahir\"];\r\n        $result[\"tglMulaiAktif\"] = $decryptedData[\"tglMulaiAktif\"];\r\n        $result[\"tglAkhirBerlaku\"] = $decryptedData[\"tglAkhirBerlaku\"];\r\n        $result[\"nmProvider\"] = $decryptedData[\"kdProviderPst\"][\"nmProvider\"];\r\n        $result[\"jnsKelas\"] = $decryptedData[\"jnsKelas\"][\"nama\"];\r\n        $result[\"jnsPeserta\"] = $decryptedData[\"jnsPeserta\"][\"nama\"];\r\n        $result[\"golDarah\"] = $decryptedData[\"golDarah\"];\r\n        $result[\"noHP\"] = $decryptedData[\"noHP\"];\r\n        $result[\"noKTP\"] = $decryptedData[\"noKTP\"];\r\n        $result[\"ketAktif\"] = $decryptedData[\"ketAktif\"];\r\n        $result[\"tunggakan\"] = $decryptedData[\"tunggakan\"];\r\n        \r\n    } else {\r\n        $errorMsg = get_pcare_decrypt_error();\r\n        echo \"Error Decrypt: \" . $errorMsg;\r\n    }\r\n}\r\n//end",
	"beforeJsCode": "// Ambil nilai NIK dan bersihkan dari karakter non-numerik\r\nvar nikValue = this.getValue();\r\nif (nikValue && nikValue.length > 0) {\r\n    // Bersihkan NIK dari tanda strip dan spasi\r\n    nikValue = nikValue.replace(/[-\\s]/g, \"\");\r\n    params[\"value\"] = nikValue;\r\n    \r\n    // Validasi panjang NIK (harus 16 digit)\r\n    if (nikValue.length !== 16) {\r\n        alert(\"NIK harus terdiri dari 16 digit!\");\r\n        return false;\r\n    }\r\n    \r\n    // Validasi NIK hanya berisi angka\r\n    if (!/^\\d+$/.test(nikValue)) {\r\n        alert(\"NIK hanya boleh berisi angka!\");\r\n        return false;\r\n    }\r\n} else {\r\n    // Jika NIK kosong, kosongkan juga tgl_lahir\r\n    params[\"value\"] = \"\";\r\n}",
	"afterJsCode": "//set field dari bridging pcare\r\n// Tampilkan hasil bridging dengan SweetAlert yang informatif dan menarik\r\n// Format PHPRunner: $result[\"key\"] di server = result[\"key\"] di client\r\nvar cNoaskes = Runner.getControl(pageid, 'noaskes');\r\ncNoaskes.setValue( result[\"noKartu\"] );\r\nvar cNama = Runner.getControl(pageid, 'nama');\r\ncNama.setValue( result[\"nama\"] );\r\nvar cSex = Runner.getControl(pageid, 'sex');\r\ncSex.setValue( result[\"sex\"] );\r\nvar cHp = Runner.getControl(pageid, 'hp');\r\ncHp.setValue( result[\"noHP\"] );\r\nvar cGolda = Runner.getControl(pageid, 'gol_darah');\r\ncGolda.setValue( result[\"golDarah\"] );\r\nvar cPcarekelas = Runner.getControl(pageid, 'pcare_kelas');\r\ncPcarekelas.setValue( result[\"jnsKelas\"] );\r\nvar cPcarejnspeserta = Runner.getControl(pageid, 'pcare_jns_peserta');\r\ncPcarejnspeserta.setValue( result[\"jnsPeserta\"] );\r\nvar cPcarestatuspeserta = Runner.getControl(pageid, 'pcare_status_peserta');\r\ncPcarestatuspeserta.setValue( result[\"ketAktif\"] );\r\nvar cPcaretglaktif = Runner.getControl(pageid, 'pcare_tgl_aktif');\r\ncPcaretglaktif.setValue( result[\"tglMulaiAktif\"] );\r\nvar cPcaretgled = Runner.getControl(pageid, 'pcare_tgl_ed');\r\ncPcaretgled.setValue( result[\"tglAkhirBerlaku\"] );\r\nvar cPcarefaskes = Runner.getControl(pageid, 'pcare_faskes');\r\ncPcarefaskes.setValue( result[\"nmProvider\"] );\r\n//end\r\n\r\n\r\n\r\nif (result[\"success\"]) {\r\n    if (result[\"birthdate\"] && result[\"birthdate\"] !== \"\") {\r\n        // Set nilai ke field tgl_Lahir\r\n        var tglLahirCtrl = Runner.getControl(pageid, \"tgl_Lahir\");\r\n        if (tglLahirCtrl) {\r\n            tglLahirCtrl.setValue(result[\"birthdate\"]);\r\n        }\r\n        \r\n        // Alternative jika menggunakan $values\r\n        // $values[\"tgl_Lahir\"] = result[\"birthdate\"];\r\n        \r\n        console.log(\"Tanggal lahir berhasil diekstrak: \" + result[\"birthdate\"]);\r\n        //parsing tgl\r\n        $(document).ready(function() {\r\n    \r\n    function calculateAge() {\r\n        var tglLahirCtrl = Runner.getControl(pageid, 'tgl_lahir');\r\n        var tglCtrl = Runner.getControl(pageid, 'tgl');\r\n        \r\n        if (!tglLahirCtrl || !tglCtrl) return;\r\n        \r\n        var tglLahir = tglLahirCtrl.getValue();\r\n        var tgl = tglCtrl.getValue();\r\n        \r\n        if (!tglLahir || !tgl) return;\r\n        \r\n        // Handle object Date or string\r\n        var birth = (tglLahir instanceof Date) ? tglLahir : parseDate(tglLahir);\r\n        var ref = (tgl instanceof Date) ? tgl : parseDate(tgl);\r\n        \r\n        if (!birth || !ref || birth > ref) {\r\n            if (birth > ref) {\r\n                alert('Error: Tanggal lahir tidak boleh lebih besar dari tanggal periksa!');\r\n            }\r\n            Runner.getControl(pageid, 'umur_t').setValue('');\r\n            Runner.getControl(pageid, 'umur_b').setValue('');\r\n            Runner.getControl(pageid, 'umur_h').setValue('');\r\n            Runner.getControl(pageid, 'usia').setValue('');\r\n            return;\r\n        }\r\n        \r\n        // Calculate age\r\n        var years = ref.getFullYear() - birth.getFullYear();\r\n        var months = ref.getMonth() - birth.getMonth();\r\n        var days = ref.getDate() - birth.getDate();\r\n        \r\n        // Adjust negative days\r\n        if (days < 0) {\r\n            var lastMonth = new Date(ref.getFullYear(), ref.getMonth(), 0);\r\n            days += lastMonth.getDate();\r\n            months--;\r\n        }\r\n        \r\n        // Adjust negative months\r\n        if (months < 0) {\r\n            months += 12;\r\n            years--;\r\n        }\r\n        \r\n        // Set values\r\n        Runner.getControl(pageid, 'umur_t').setValue(years);\r\n        Runner.getControl(pageid, 'umur_b').setValue(months);\r\n        Runner.getControl(pageid, 'umur_h').setValue(days);\r\n        \r\n        var usia = '';\r\n        if (years > 0) usia += years + ' tahun ';\r\n        if (months > 0) usia += months + ' bulan ';\r\n        if (days > 0) usia += days + ' hari';\r\n        \r\n        Runner.getControl(pageid, 'usia').setValue(usia.trim());\r\n    }\r\n    \r\n    function parseDate(dateStr) {\r\n        if (!dateStr || typeof dateStr !== 'string') return null;\r\n        \r\n        var parts = dateStr.split('/');\r\n        if (parts.length === 3) {\r\n            var day = parseInt(parts[0]);\r\n            var month = parseInt(parts[1]) - 1;\r\n            var year = parseInt(parts[2]);\r\n            \r\n            var date = new Date(year, month, day);\r\n            \r\n            if (date.getFullYear() === year && \r\n                date.getMonth() === month && \r\n                date.getDate() === day) {\r\n                return date;\r\n            }\r\n        }\r\n        \r\n        var isoDate = new Date(dateStr);\r\n        if (!isNaN(isoDate.getTime())) {\r\n            return isoDate;\r\n        }\r\n        \r\n        return null;\r\n    }\r\n    \r\n    // Bind events\r\n    Runner.getControl(pageid, 'tgl_lahir').on('change', calculateAge);\r\n    Runner.getControl(pageid, 'tgl').on('change', calculateAge);\r\n    \r\n    // Initial trigger\r\n    setTimeout(calculateAge, 500);\r\n});\r\n        \r\n        //end\r\n    } else {\r\n        // Kosongkan field jika NIK kosong\r\n        var tglLahirCtrl = Runner.getControl(pageid, \"tgl_Lahir\");\r\n        if (tglLahirCtrl) {\r\n            tglLahirCtrl.setValue(\"\");\r\n        }\r\n    }\r\n} else {\r\n    // Tampilkan error jika ada\r\n    if (result[\"error\"] && result[\"error\"] !== \"\") {\r\n        alert(\"Error: \" + result[\"error\"]);\r\n    }\r\n    \r\n    // Kosongkan field tanggal lahir\r\n    var tglLahirCtrl = Runner.getControl(pageid, \"tgl_Lahir\");\r\n    if (tglLahirCtrl) {\r\n        tglLahirCtrl.setValue(\"\");\r\n    }\r\n}\r\n\r\n"
}