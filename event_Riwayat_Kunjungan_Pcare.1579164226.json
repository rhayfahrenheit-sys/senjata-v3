{
	"type": "EVENT_BUTTON",
	"name": "Riwayat Kunjungan Pcare",
	"serverCode": "\r\n// Setup konfigurasi kredensial (sesuaikan dengan variabel Anda)\r\nloadSecrets();\r\n$keyenc=RM;\r\n$cons=msy_decrypt('cons',$keyenc);\r\n$password=msy_decrypt('password',$keyenc);\r\n$user_key=msy_decrypt('user_key',$keyenc);\r\n$secret=msy_decrypt('secret',$keyenc);\r\n\r\n\r\n\r\n$sp=DB::PrepareSQL(\"select user1,kode_provider,\".$cons.\",\".$password.\",\".$user_key.\",\".$secret.\" from puskesmas where pusk_id=:1\",$_SESSION[\"puskesmas\"]);\r\n\r\n$rs=DB::Query($sp);\r\nwhile( $data = $rs->fetchAssoc() )\r\n{\r\n$cons1 = $data[\"cons\"];\r\n$password1 = $data[\"password\"];\r\n$user_key1 = $data[\"user_key\"];\r\n$user1 = $data[\"user1\"];\r\n$secret1= $data[\"secret\"];\r\n}\r\n\r\n\tdate_default_timezone_set('UTC'); \r\n\t$stamp = strval(time()-strtotime('1970-01-01 00:00:00'));\r\n\t//$stamp\t\t= time();\r\n\t$data \t\t= $cons1.'&'.$stamp;\r\n\t$key\t\t= $cons1.$secret1.$stamp;\r\n\r\n$config = array(\r\n    'consID'     => $cons1,\r\n    'secretKey'  => $secret1,\r\n    'user_key'   => $user_key1,\r\n    'pcareUname' => $user1,\r\n    'pcarePWD'   => $password1,\r\n    'kdAplikasi' => '095' // default, bisa diubah jika perlu\r\n);\r\n\r\n// Base URL PCare\r\n$base_url = $_SESSION[\"base_url_pcare\"];\r\n\r\n// ============ CONTOH 1: Get Peserta by NOKA ============\r\n$noKartu = $params['noaskes'];\r\n$result_pcare = pcare_get_riwayat_kunjungan($base_url, $noKartu, $config);\r\n\r\n\r\n\r\nif ($result_pcare['success']) {\r\n    $responseData = $result_pcare['data'][\"response\"];\r\n    \r\n    // Decrypt data\r\n    $decryptedData = decrypt_pcare_data($responseData, $key);\r\n    \r\n    if ($decryptedData !== null) {\r\n        \r\n        // Sort berdasarkan tanggal (terbaru di atas)\r\n        if (!empty($decryptedData['list'])) {\r\n            usort($decryptedData['list'], function($a, $b) {\r\n                $dateA = DateTime::createFromFormat('d-m-Y', $a['tglKunjungan'] ?? '');\r\n                $dateB = DateTime::createFromFormat('d-m-Y', $b['tglKunjungan'] ?? '');\r\n                \r\n                if (!$dateA || !$dateB) return 0;\r\n                return $dateB <=> $dateA; // Descending\r\n            });\r\n        }\r\n        \r\n        // Generate HTML untuk popup\r\n        $html = \"<div style='font-family: Arial, sans-serif; padding: 15px;'>\";\r\n        \r\n        // Header\r\n        $html .= \"<div style='background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;'>\";\r\n        $html .= \"<h2 style='margin: 0; font-size: 20px;'>üìã Riwayat Kunjungan PCare</h2>\";\r\n        $html .= \"<p style='margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;'>No. Kartu: \" . htmlspecialchars($noKartu) . \"</p>\";\r\n        $html .= \"<p style='margin: 3px 0 0 0; opacity: 0.9; font-size: 14px;'>Total Kunjungan: \" . ($decryptedData['count'] ?? count($decryptedData['list'])) . \"</p>\";\r\n        $html .= \"</div>\";\r\n        \r\n        // Loop data kunjungan\r\n        if (!empty($decryptedData['list'])) {\r\n            foreach ($decryptedData['list'] as $index => $kunj) {\r\n                $html .= \"<div style='background: #f8f9fa; border-left: 4px solid #667eea; padding: 15px; margin-bottom: 15px; border-radius: 5px;'>\";\r\n                \r\n                // Header kunjungan\r\n                $html .= \"<div style='display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;'>\";\r\n                $html .= \"<div>\";\r\n                $html .= \"<strong style='font-size: 16px; color: #333;'>Kunjungan #\" . ($index + 1) . \"</strong>\";\r\n                $html .= \"<br><span style='color: #666; font-size: 13px;'>No. Kunjungan: \" . htmlspecialchars($kunj['noKunjungan'] ?? '-') . \"</span>\";\r\n                $html .= \"</div>\";\r\n                $html .= \"<div style='background: #667eea; color: white; padding: 5px 12px; border-radius: 20px; font-weight: bold;'>\";\r\n                $html .= \"<i class='fa fa-calendar'></i> \" . htmlspecialchars($kunj['tglKunjungan'] ?? '-');\r\n                $html .= \"</div>\";\r\n                $html .= \"</div>\";\r\n                \r\n                // Grid informasi\r\n                $html .= \"<div style='display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-bottom: 10px;'>\";\r\n                \r\n                // Faskes\r\n                $html .= \"<div>\";\r\n                $html .= \"<small style='color: #888; font-weight: bold;'>üè• Faskes</small>\";\r\n                $html .= \"<br><strong>\" . htmlspecialchars($kunj['providerPelayanan']['nmProvider'] ?? '-') . \"</strong>\";\r\n                $html .= \"<br><small style='color: #666;'>\" . htmlspecialchars($kunj['providerPelayanan']['kdProvider'] ?? '') . \"</small>\";\r\n                $html .= \"</div>\";\r\n                \r\n                // Poli\r\n                $html .= \"<div>\";\r\n                $html .= \"<small style='color: #888; font-weight: bold;'>ü©∫ Poli</small>\";\r\n                $html .= \"<br><strong>\" . htmlspecialchars($kunj['poli']['nmPoli'] ?? '-') . \"</strong>\";\r\n                $html .= \"<br><small style='color: #666;'>\" . htmlspecialchars($kunj['poli']['kdPoli'] ?? '') . \"</small>\";\r\n                $html .= \"</div>\";\r\n                \r\n                // Dokter\r\n                $html .= \"<div>\";\r\n                $html .= \"<small style='color: #888; font-weight: bold;'>üë®‚Äç‚öïÔ∏è Dokter</small>\";\r\n                $html .= \"<br><strong>\" . htmlspecialchars($kunj['dokter']['nmDokter'] ?? '-') . \"</strong>\";\r\n                $html .= \"<br><small style='color: #666;'>\" . htmlspecialchars($kunj['dokter']['kdDokter'] ?? '') . \"</small>\";\r\n                $html .= \"</div>\";\r\n                \r\n                // Diagnosa 1\r\n                $html .= \"<div>\";\r\n                $html .= \"<small style='color: #888; font-weight: bold;'>üìã Diagnosa</small>\";\r\n                $html .= \"<br><strong>\" . htmlspecialchars($kunj['diagnosa1']['nmDiag'] ?? '-') . \"</strong>\";\r\n                $html .= \"<br><small style='color: #666;'>\" . htmlspecialchars($kunj['diagnosa1']['kdDiag'] ?? '') . \"</small>\";\r\n                $html .= \"</div>\";\r\n                \r\n                $html .= \"</div>\";\r\n                \r\n                // Detail tambahan (collapsed)\r\n                $html .= \"<div style='border-top: 1px solid #e0e0e0; padding-top: 10px; margin-top: 10px;'>\";\r\n                $html .= \"<div style='display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;'>\";\r\n                \r\n                // Keluhan\r\n                $html .= \"<div>\";\r\n                $html .= \"<small style='color: #888; font-weight: bold;'>üí¨ Keluhan</small>\";\r\n                $html .= \"<br><span style='color: #555;'>\" . htmlspecialchars($kunj['keluhan'] ?? '-') . \"</span>\";\r\n                $html .= \"</div>\";\r\n                \r\n                // Status Pulang\r\n                $html .= \"<div>\";\r\n                $html .= \"<small style='color: #888; font-weight: bold;'>üö™ Status Pulang</small>\";\r\n                $html .= \"<br><span style='color: #555;'>\" . htmlspecialchars($kunj['statusPulang']['nmStatusPulang'] ?? '-') . \"</span>\";\r\n                $html .= \"</div>\";\r\n                \r\n                // TKP\r\n                $html .= \"<div>\";\r\n                $html .= \"<small style='color: #888; font-weight: bold;'>üè∑Ô∏è TKP</small>\";\r\n                $html .= \"<br><span style='color: #555;'>\" . htmlspecialchars($kunj['tkp']['nmTkp'] ?? '-') . \"</span>\";\r\n                $html .= \"</div>\";\r\n                \r\n                // Tanggal Pulang\r\n                $html .= \"<div>\";\r\n                $html .= \"<small style='color: #888; font-weight: bold;'>üìÖ Tgl Pulang</small>\";\r\n                $html .= \"<br><span style='color: #555;'>\" . htmlspecialchars($kunj['tglPulang'] ?? '-') . \"</span>\";\r\n                $html .= \"</div>\";\r\n                \r\n                $html .= \"</div>\";\r\n                $html .= \"</div>\";\r\n                \r\n                $html .= \"</div>\";\r\n                \r\n                // Contoh tambah field tekanan darah\r\n                $html .= \"<div>\";\r\n                $html .= \"<small style='color: #888; font-weight: bold;'>ü´Ä Tekanan Darah</small>\";\r\n                $html .= \"<br><span style='color: #555;'>\" . $kunj['sistole'] . \" / \" . $kunj['diastole'] . \" mmHg</span>\";\r\n                $html .= \"</div>\";\r\n            }\r\n            \r\n        } else {\r\n            $html .= \"<div style='text-align: center; padding: 40px; color: #999;'>\";\r\n            $html .= \"<i class='fa fa-inbox' style='font-size: 48px; margin-bottom: 10px;'></i>\";\r\n            $html .= \"<p>Tidak ada riwayat kunjungan</p>\";\r\n            $html .= \"</div>\";\r\n        }\r\n        \r\n        $html .= \"</div>\";\r\n        $result[\"html\"]=$html;\r\n        \r\n        // Tampilkan popup\r\n        // echo \"\r\n        // <script>\r\n        // Runner.displayPopup({\r\n        //     html: \" . json_encode($html) . \",\r\n        //     header: 'Riwayat Kunjungan PCare - \" . htmlspecialchars($noKartu) . \"',\r\n        //     width: 900,\r\n        //     height: 600,\r\n        //     overlay: true\r\n        // });\r\n        // </script>\r\n        // \";\r\n        \r\n    } else {\r\n        echo \"<script>alert('Error Decrypt: \" . addslashes(\\PCare\\DecryptHelper::getLastError()) . \"');</script>\";\r\n    }\r\n    \r\n} else {\r\n    echo \"<script>alert('Error API: \" . addslashes($result['error']) . \"\\\\nHTTP Code: \" . $result['http_code'] . \"');</script>\";\r\n}",
	"beforeJsCode": "var ctrlKtp = Runner.getControl(pageid, 'ktp');\n params['ktp']= ctrlKtp.getValue();\n \n var ctrlNoaskes = Runner.getControl(pageid, 'noaskes');\n params['noaskes']= ctrlNoaskes.getValue();",
	"afterJsCode": "// Decode HTML dari result\r\nvar htmlContent = result[\"html\"];\r\n\r\n// Tampilkan popup dengan konten HTML\r\nvar popup = Runner.displayPopup({\r\n    html: htmlContent,\r\n    header: 'Daftar Riwayat Kunjungan Pcare',\r\n    width: \"100%\",\r\n    height: \"100%\",\r\n    overlay: true\r\n});"
}