{
	"type": "EVENT_BUTTON",
	"name": "Lihat Rujukan Pcare",
	"serverCode": "$noKunjungan = \"1303U0461125P000347\";\r\nloadSecrets();\r\n$keyenc=RM;\r\n$cons=msy_decrypt('cons',$keyenc);\r\n$password=msy_decrypt('password',$keyenc);\r\n$user_key=msy_decrypt('user_key',$keyenc);\r\n$secret=msy_decrypt('secret',$keyenc);\r\n$sp=DB::PrepareSQL(\"select user1,kode_provider,\".$cons.\",\".$password.\",\".$user_key.\",\".$secret.\" from puskesmas where pusk_id=:1\",$_SESSION[\"puskesmas\"]);\r\n$rs=DB::Query($sp);\r\nwhile( $data = $rs->fetchAssoc() )\r\n{\r\n    $cons1 = $data[\"cons\"];\r\n    $password1 = $data[\"password\"];\r\n    $user_key1 = $data[\"user_key\"];\r\n    $user1 = $data[\"user1\"];\r\n    $secret1= $data[\"secret\"];\r\n}\r\n\r\ndate_default_timezone_set('UTC'); \r\n$kdAplikasi = \"095\"; \r\n$stamp = strval(time()-strtotime('1970-01-01 00:00:00'));\r\n$data = $cons1.'&'.$stamp;\r\n$key = $cons1.$secret1.$stamp;\r\n$signature = hash_hmac('sha256', $data, $secret1, true);\r\n$encodedSignature = base64_encode($signature);\r\n$encodedAuthorization = base64_encode($user1.':'.$password1.':'.$kdAplikasi);\r\n\r\n$base_url = $_SESSION[\"base_url_pcare\"];\r\n$curl = curl_init();\r\ncurl_setopt_array($curl, array(\r\n   CURLOPT_URL => $base_url.\"/kunjungan/rujukan/\".$noKunjungan,\r\n   CURLOPT_RETURNTRANSFER => true,\r\n   CURLOPT_ENCODING => '',\r\n   CURLOPT_MAXREDIRS => 10,\r\n   CURLOPT_TIMEOUT => 10,\r\n   CURLOPT_FOLLOWLOCATION => true,\r\n   CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,\r\n   CURLOPT_CUSTOMREQUEST => 'GET',\r\n   CURLOPT_HTTPHEADER => array(\r\n      'Accept: application/json',\r\n      'X-cons-id:'.$cons1,\r\n      'X-timestamp:'.$stamp,\r\n      'X-signature:'.$encodedSignature,\r\n      'X-authorization:Basic '.$encodedAuthorization,\r\n      'user_key: '.$user_key1\r\n   ),\r\n));\r\n\r\n$response = curl_exec($curl);\r\n$http_code = curl_getinfo($curl, CURLINFO_HTTP_CODE);\r\ncurl_close($curl);\r\n\r\n// Decode response\r\n$result = json_decode($response, true);\r\necho $result;\r\n/*\r\n// Cek apakah response berhasil\r\nif ($http_code == 200 && isset($result['response'])) {\r\n    // Decrypt response PCare (response biasanya ter-encrypt)\r\n    $decrypted = pcare_decrypt($result['response'], $cons1, $key);\r\n    $finalData = json_decode($decrypted, true);\r\n    \r\n    if ($finalData && !isset($finalData['metaData']['code']) || $finalData['metaData']['code'] == 200) {\r\n        echo \"Data Rujukan Berhasil!<br>\";\r\n        echo \"<pre>\";\r\n        print_r($finalData);\r\n        echo \"</pre>\";\r\n        \r\n        // Akses data jika ada\r\n        if(isset($finalData['response'])) {\r\n            echo \"Nomor Rujukan: \" . ($finalData['response']['noRujukan'] ?? '-') . \"<br>\";\r\n            echo \"Nama Pasien: \" . ($finalData['response']['nmPst'] ?? '-') . \"<br>\";\r\n            echo \"Poli Tujuan: \" . ($finalData['response']['poliRujukan']['nmPoli'] ?? '-') . \"<br>\";\r\n        }\r\n    } else {\r\n        echo \"Error: \" . ($finalData['metaData']['message'] ?? 'Unknown error');\r\n        echo \"<pre>\";\r\n        print_r($finalData);\r\n        echo \"</pre>\";\r\n    }\r\n} else {\r\n    echo \"Error API (HTTP $http_code)<br>\";\r\n    echo \"<pre>\";\r\n    print_r($result);\r\n    echo \"</pre>\";\r\n}\r\n\r\n// Fungsi decrypt PCare (jika belum ada)\r\nfunction pcare_decrypt($string, $cons_id, $key) {\r\n    $encrypt_method = 'AES-256-CBC';\r\n    $key = $cons_id . $secret_key . $cons_id;\r\n    $key_hash = hex2bin(hash('sha256', $key));\r\n    $iv = substr(hex2bin(hash('sha256', $key)), 0, 16);\r\n    $output = openssl_decrypt(base64_decode($string), $encrypt_method, $key_hash, OPENSSL_RAW_DATA, $iv);\r\n    $output = \\LZCompressor\\LZString::decompressFromEncodedURIComponent($output);\r\n    return $output;\r\n}\r\n*/",
	"beforeJsCode": "// // Ambil nilai NIK dan bersihkan dari karakter non-numerik\r\n// var ctrlKtp = Runner.getControl(pageid, 'ktp');\r\n//  //params['ktp']= ctrlKtp.getValue();\r\n \r\n \r\n// var nikValue = ctrlKtp.getValue();\r\n// if (nikValue && nikValue.length > 0) {\r\n//     // Bersihkan NIK dari tanda strip dan spasi\r\n//     nikValue = nikValue.replace(/[-\\s]/g, \"\");\r\n//     params[\"value\"] = nikValue;\r\n    \r\n//     // Validasi panjang NIK (harus 16 digit)\r\n//     if (nikValue.length !== 16) {\r\n//         alert(\"NIK harus terdiri dari 16 digit!\");\r\n//         return false;\r\n//     }\r\n    \r\n//     // Validasi NIK hanya berisi angka\r\n//     if (!/^\\d+$/.test(nikValue)) {\r\n//         alert(\"NIK hanya boleh berisi angka!\");\r\n//         return false;\r\n//     }\r\n// } else {\r\n//     // Jika NIK kosong, kosongkan juga tgl_lahir\r\n//     params[\"value\"] = \"\";\r\n// }\r\n\r\n",
	"afterJsCode": "// Put your code here.\n\n// var message = result[\"txt\"] + \" !!!\";\n// ajax.setMessage(message);\n"
}